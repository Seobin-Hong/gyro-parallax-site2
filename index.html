<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Gyro Parallax Graffiti</title>
<style>
  :root{ --perspective:900px; --strengthZ:120; --strengthXY:30; --tiltStrength:6; --bg:#0d0d0f; }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .stage{position:relative;height:100dvh;overflow:hidden;perspective:var(--perspective);
         background:radial-gradient(ellipse at 50% 20%,#17171c 0%,#0d0d0f 60%);} 
  .board{position:absolute;inset:0;margin:auto;transform-style:preserve-3d;will-change:transform}
  .layer{position:absolute;left:50%;top:50%;transform-style:preserve-3d;will-change:transform;transition:transform .35s ease}
  .sticker{
    position:absolute;
    transform:translate(-50%,-50%);
    will-change:transform;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.28));
    transition: transform .35s ease;
  }
  .ui{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:8px;align-items:center;justify-content:space-between;
      font-size:12px;color:#bbb;z-index:9999}
  .btn{padding:8px 12px;background:#1b1b22;border:1px solid #2a2a34;border-radius:10px;color:#ddd;cursor:pointer}
  .hint{opacity:.75}
  @media (prefers-reduced-motion: reduce){ :root{ --strengthZ:40; --strengthXY:8; --tiltStrength:2 } }
</style>
</head>
<body>
  <div class="stage" id="stage"><div class="board" id="board"></div></div>

  <div class="ui">
    <button class="btn" id="ios">Enable Motion Sensor (iOS)</button>
    <div class="hint">Tilt your device (or move your mouse)</div>
  </div>

<script>
const GLOBAL_SCALE = 0.9;

/* ---------- 2) Layer data ---------- */
const LAYERS = [
  { file:"assets/background.png", depth:-3, x:50, y:50, scale:1.00, alt:"wall" },
  { file:"assets/1.png",  depth:-2, x:28, y:40, scale:0.90, alt:"bulb L" },
  { file:"assets/2.png",  depth:0,  x:32, y:55, scale:1.00, alt:"kill your greed" },
  { file:"assets/3.png",  depth:-1, x:45, y:46, scale:1.00, alt:"frankenstein" },
  { file:"assets/4.png",  depth:-1, x:60, y:46, scale:0.90, alt:"bw face" },
  { file:"assets/5.png",  depth:-2, x:75, y:41, scale:0.92, alt:"bulb R" },
  { file:"assets/6.png",  depth:0,  x:56, y:66, scale:1.08, alt:"halloween" },
  { file:"assets/7.png",  depth:1,  x:66, y:60, scale:0.95, alt:"small face" },
  { file:"assets/8.png",  depth:1,  x:76, y:58, scale:0.95, alt:"small char" },
  { file:"assets/9.png",  depth:1,  x:82, y:62, scale:1.00, alt:"right man" },
  { file:"assets/10.png", depth:2,  x:40, y:30, scale:1.06, alt:"bird" },
  { file:"assets/11.png", depth:2,  x:70, y:66, scale:1.10, alt:"monkey" },
  { file:"assets/12.png", depth:3,  x:72, y:76, scale:1.15, alt:"yellow poster" },
  { file:"assets/13.png", depth:3,  x:85, y:71, scale:1.00, alt:"orange sticker" },
  { file:"assets/14.png", depth:3,  x:88, y:79, scale:0.85, alt:"tiny white" }
];

/* ---------- 3) Settings & state ---------- */
const css = getComputedStyle(document.documentElement);
const STRENGTH_Z  = parseFloat(css.getPropertyValue('--strengthZ')) || 120;
const STRENGTH_XY = parseFloat(css.getPropertyValue('--strengthXY')) || 30;
const TILT_STRENGTH = parseFloat(css.getPropertyValue('--tiltStrength')) || 6;
const stage = document.getElementById('stage');
const board = document.getElementById('board');
const target = { pitch:0, roll:0, yaw:0 };
const state  = { pitch:0, roll:0, yaw:0 };
const clamp = (v,min,max) => Math.min(max, Math.max(min, v));
const lerp  = (a,b,t) => a + (b - a) * t;

/* ---------- 3.5) Intensity knobs ---------- */
const MOTION_GAIN = 1.3;                // 살짝 낮춤
const SCALE_POP_NEAR = [0.94, 1.07];    // 팝 강도 약간 낮춤
const SCALE_POP_BG   = [0.95, 1.03];    // 배경 그대로 유지

/* ---------- 4) DOM creation ---------- */
const nodes = [];
for (const layer of LAYERS){
  const layerEl = document.createElement('div');
  layerEl.className = 'layer';
  layerEl.dataset.depth = String(layer.depth);
  const img = new Image();
  img.decoding = 'async';
  img.src = layer.file;
  img.alt = layer.alt || '';
  img.className = 'sticker';
  img.style.left = layer.x + '%';
  img.style.top = layer.y + '%';
  img.style.transform = `translate(-50%,-50%) scale(${layer.scale * GLOBAL_SCALE})`;
  layerEl.appendChild(img);
  board.appendChild(layerEl);
  nodes.push({ layer, layerEl, img });
}

/* ---------- 5) Utility ---------- */
function smoothstep(edge0, edge1, x){
  const t = Math.min(1, Math.max(0, (x - edge0) / (edge1 - edge0)));
  return t * t * (3 - 2 * t);
}

/* ---------- 6) Render loop ---------- */
function tick(){
  state.pitch = lerp(state.pitch, target.pitch, 0.12);
  state.roll  = lerp(state.roll , target.roll , 0.12);
  state.yaw   = lerp(state.yaw  , target.yaw  , 0.08);

  const tiltMag = Math.min(1, Math.sqrt(state.pitch*state.pitch + state.roll*state.roll));

  board.style.transform = `rotateX(${state.pitch*TILT_STRENGTH}deg) rotateY(${-state.roll*TILT_STRENGTH}deg)`;

  const depths = nodes.map(n => parseFloat(n.layerEl.dataset.depth) || 0);
  const minD = Math.min(...depths), maxD = Math.max(...depths);

  for (const n of nodes){
    const d = parseFloat(n.layerEl.dataset.depth) || 0;
    const isBG = (d <= -3) || /background/i.test(n.layer.file);
    const gain = isBG ? 1 : MOTION_GAIN;

    const z = (d/3) * STRENGTH_Z * (0.6 + state.pitch) * gain;
    const x = (d/3) * state.roll  * STRENGTH_XY * gain;
    const y = (d/3) * state.pitch * STRENGTH_XY * gain;
    n.layerEl.style.transform = `translate3d(${x}px, ${y}px, ${z}px)`;
    n.layerEl.style.zIndex = String(Math.round((d*10) + z));

    const baseReveal = (d - minD) / Math.max(1, (maxD - minD));
    const needBase = n.layer.reveal ?? (0.15 + baseReveal * 0.55);
    let needStart = needBase - 0.08;
    let needEnd   = needBase + 0.08;

    const roll = state.roll;
    const dirI = Math.min(1, Math.abs(roll));
    const px   = (n.layer.x ?? 50) / 100;
    const sideFavor = (roll < 0) ? px : (1 - px);
    const BIAS_GAIN = 0.25;
    const bias = sideFavor * dirI * BIAS_GAIN;
    needStart -= bias;
    needEnd   -= bias;

    const done = smoothstep(needStart, needEnd, tiltMag);
    const [s0, s1] = isBG ? SCALE_POP_BG : SCALE_POP_NEAR;
    const appearScale = s0 + (s1 - s0) * done;

    n.img.style.transform =
      `translate(-50%,-50%) scale(${(n.layer.scale * GLOBAL_SCALE * appearScale).toFixed(3)})`;
  }
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ---------- 7) Sensor setup ---------- */
function setupOrientation(){
  if ('DeviceOrientationEvent' in window){
    window.addEventListener('deviceorientation', (e) => {
      const beta  = e.beta  ?? 0; const gamma = e.gamma ?? 0; const alpha = e.alpha ?? 0;
      target.pitch = clamp(beta/90, -1, 1);
      target.roll  = clamp(gamma/90, -1, 1);
      target.yaw   = (alpha % 360)/180 - 1;
    }, { passive:true });
  }
}
const iosBtn = document.getElementById('ios');
iosBtn.addEventListener('click', async () => {
  try{
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function'){
      const res = await DeviceOrientationEvent.requestPermission();
      if (res === 'granted') setupOrientation();
    } else { setupOrientation(); }
  }catch(e){ console.warn(e); }
});
setupOrientation();

stage.addEventListener('pointermove', (e) => {
  const r = stage.getBoundingClientRect();
  const nx = (e.clientX - r.left) / r.width  * 2 - 1;
  const ny = (e.clientY - r.top ) / r.height * 2 - 1;
  target.roll  = clamp(nx, -1, 1);
  target.pitch = clamp(-ny, -1, 1);
});
</script>
</body>
</html>
